        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>HistoryImpl class / dart_web_toolkit_ui Library / API Reference / Dart Web Toolkit</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="//fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40672112-1']);
  _gaq.push(['_setDomainName', 'dartwebtoolkit.com']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
        <body data-library="dart_web_toolkit_ui" data-type="HistoryImpl">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">API Reference 0.3.8+1</a>
         &rsaquo; <a href="../dart_web_toolkit_ui.html">dart_web_toolkit_ui</a> &rsaquo; <a href="../dart_web_toolkit_ui/HistoryImpl.html">HistoryImpl</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
</div>
<div class="content">
        <h2><strong>HistoryImpl</strong>
          class
        </h2>
        
<button id="show-inherited" class="show-inherited">Hide inherited</button>
<div class="doc">
<p>Native implementation associated with
{@link com.google.gwt.user.client.History}. User classes should not use this
class directly.</p><p>
This base version uses the HTML5 standard window.onhashchange event to
determine when the URL hash identifier changes.
</p>
<pre class="source">
class HistoryImpl implements HasValueChangeHandlers&lt;String&gt; {

 static String _token = "";

 static String getToken() {
   return (_token == null) ? "" : _token;
 }

 static void setToken(String token) {
   HistoryImpl._token = token;
 }

 EventBus _handlers = new SimpleEventBus();

 //*****************************************
 // Implementation of HasValueChangeHandlers
 //*****************************************

 /**
  * Adds a {@link ValueChangeEvent} handler to be informed of changes to the
  * browser's history stack.
  *
  * @param handler the handler
  */
 HandlerRegistration addValueChangeHandler(ValueChangeHandler&lt;String&gt; handler) {
   return _handlers.addHandler(ValueChangeEvent.TYPE, handler);
 }

 //****

 String encodeFragment(String fragment) {
   // encodeURI() does *not* encode the '#' character.
   return fragment; //encodeURI(fragment).replace("#", "%23");
 }

 String decodeFragment(String encodedFragment) {
   // decodeURI() does *not* decode the '#' character.
   return encodedFragment; //decodeURI(encodedFragment.replace("%23", "#"));
 }

 void fireEvent(DwtEvent event) {
   _handlers.fireEvent(event);
 }

 /**
  * Fires the {@link ValueChangeEvent} to all handlers with the given tokens.
  */
 void fireHistoryChangedImpl(String newToken) {
   ValueChangeEvent.fire(this, newToken);
 }

 EventBus getHandlers() {
   return _handlers;
 }

 bool init() {

   var token = '';

   // Get the initial token from the url's hash component.
   String hash = dart_html.window.location.hash;
   if (hash.length &gt; 0) {
     token = decodeFragment(hash.substring(1));
   }

   HistoryImpl.setToken(token);

   //var historyImpl = this;

   //var oldHandler = dart_html.window.on["hashchange"];

   dart_html.window.onHashChange.listen((dart_html.Event event) {
     var token = '';
     String hash = dart_html.window.location.hash;
     if (hash.length &gt; 0) {
       token = decodeFragment(hash.substring(1));
     }

     HistoryImpl.setToken(token);

//      if (oldHandler) {
//        oldHandler();
//      }
   });

   return true;

 }

 void newItem(String historyToken, bool issueEvent) {
   historyToken = (historyToken == null) ? "" : historyToken;
   if (historyToken != getToken()) {
     setToken(historyToken);
     nativeUpdate(historyToken);
     if (issueEvent) {
       fireHistoryChangedImpl(historyToken);
     }
   }
 }

 void newItemOnEvent(String historyToken) {
   historyToken = (historyToken == null) ? "" : historyToken;
   if (historyToken != getToken()) {
     setToken(historyToken);
     nativeUpdateOnEvent(historyToken);
     fireHistoryChangedImpl(historyToken);
   }
 }

 void nativeUpdate(String historyToken) {
   //$wnd.location.hash = this.@com.google.gwt.user.client.impl.HistoryImpl::encodeFragment(Ljava/lang/String;)(historyToken);
   dart_html.window.location.hash = encodeFragment(historyToken);
 }

 void nativeUpdateOnEvent(String historyToken) {
   // Do nothing, the hash is already updated.
 }
}
</pre>
</div>
<h3>Implements</h3>
<p>
<span class="type-box"><span class="icon-class"></span><a href="../dart_web_toolkit_event/HasValueChangeHandlers.html">HasValueChangeHandlers&lt;String&gt;</a></span></p>
<div>
<h3>Static Methods</h3>
<div class="method"><h4 id="getToken">
<button class="show-code">Code</button>
String <strong>getToken</strong>() <a class="anchor-link" href="#getToken"
              title="Permalink to HistoryImpl.getToken">#</a></h4>
<div class="doc">
<pre class="source">
static String getToken() {
 return (_token == null) ? "" : _token;
}
</pre>
</div>
</div>
<div class="method"><h4 id="setToken">
<button class="show-code">Code</button>
void <strong>setToken</strong>(String token) <a class="anchor-link" href="#setToken"
              title="Permalink to HistoryImpl.setToken">#</a></h4>
<div class="doc">
<pre class="source">
static void setToken(String token) {
 HistoryImpl._token = token;
}
</pre>
</div>
</div>
</div>
<div>
<h3>Methods</h3>
<div class="method"><h4 id="addValueChangeHandler">
<button class="show-code">Code</button>
<a href="../dart_web_toolkit_event/HandlerRegistration.html">HandlerRegistration</a> <strong>addValueChangeHandler</strong>(<a href="../dart_web_toolkit_event/ValueChangeHandler.html">ValueChangeHandler</a>&lt;String&gt; handler) <a class="anchor-link" href="#addValueChangeHandler"
              title="Permalink to HistoryImpl.addValueChangeHandler">#</a></h4>
<div class="doc">
<p>Adds a {@link ValueChangeEvent} handler to be informed of changes to the
browser's history stack.</p>
<p>@param handler the handler</p>
<pre class="source">
HandlerRegistration addValueChangeHandler(ValueChangeHandler&lt;String&gt; handler) {
 return _handlers.addHandler(ValueChangeEvent.TYPE, handler);
}
</pre>
</div>
</div>
<div class="method"><h4 id="decodeFragment">
<button class="show-code">Code</button>
String <strong>decodeFragment</strong>(String encodedFragment) <a class="anchor-link" href="#decodeFragment"
              title="Permalink to HistoryImpl.decodeFragment">#</a></h4>
<div class="doc">
<pre class="source">
String decodeFragment(String encodedFragment) {
 // decodeURI() does *not* decode the '#' character.
 return encodedFragment; //decodeURI(encodedFragment.replace("%23", "#"));
}
</pre>
</div>
</div>
<div class="method"><h4 id="encodeFragment">
<button class="show-code">Code</button>
String <strong>encodeFragment</strong>(String fragment) <a class="anchor-link" href="#encodeFragment"
              title="Permalink to HistoryImpl.encodeFragment">#</a></h4>
<div class="doc">
<pre class="source">
String encodeFragment(String fragment) {
 // encodeURI() does *not* encode the '#' character.
 return fragment; //encodeURI(fragment).replace("#", "%23");
}
</pre>
</div>
</div>
<div class="method"><h4 id="fireEvent">
<button class="show-code">Code</button>
void <strong>fireEvent</strong>(<a href="../dart_web_toolkit_event/DwtEvent.html">DwtEvent</a> event) <a class="anchor-link" href="#fireEvent"
              title="Permalink to HistoryImpl.fireEvent">#</a></h4>
<div class="doc">
<div class="inherited">
<p>Fires the given event to the handlers listening to the event's type.</p>
<p>Any exceptions thrown by handlers will be bundled into a
<code>UmbrellaException</code> and then re-thrown after all handlers have
completed. An exception thrown by a handler will not prevent other handlers
from executing.</p>
<p>@param event the event</p>
<div class="docs-inherited-from">docs inherited from <a href="../dart_web_toolkit_event/HasHandlers.html">HasHandlers</a> </div></div>
<pre class="source">
void fireEvent(DwtEvent event) {
 _handlers.fireEvent(event);
}
</pre>
</div>
</div>
<div class="method"><h4 id="fireHistoryChangedImpl">
<button class="show-code">Code</button>
void <strong>fireHistoryChangedImpl</strong>(String newToken) <a class="anchor-link" href="#fireHistoryChangedImpl"
              title="Permalink to HistoryImpl.fireHistoryChangedImpl">#</a></h4>
<div class="doc">
<p>Fires the {@link ValueChangeEvent} to all handlers with the given tokens.</p>
<pre class="source">
void fireHistoryChangedImpl(String newToken) {
 ValueChangeEvent.fire(this, newToken);
}
</pre>
</div>
</div>
<div class="method"><h4 id="getHandlers">
<button class="show-code">Code</button>
<a href="../dart_web_toolkit_event/EventBus.html">EventBus</a> <strong>getHandlers</strong>() <a class="anchor-link" href="#getHandlers"
              title="Permalink to HistoryImpl.getHandlers">#</a></h4>
<div class="doc">
<pre class="source">
EventBus getHandlers() {
 return _handlers;
}
</pre>
</div>
</div>
<div class="method"><h4 id="init">
<button class="show-code">Code</button>
bool <strong>init</strong>() <a class="anchor-link" href="#init"
              title="Permalink to HistoryImpl.init">#</a></h4>
<div class="doc">
<pre class="source">
bool init() {

 var token = '';

 // Get the initial token from the url's hash component.
 String hash = dart_html.window.location.hash;
 if (hash.length &gt; 0) {
   token = decodeFragment(hash.substring(1));
 }

 HistoryImpl.setToken(token);

 //var historyImpl = this;

 //var oldHandler = dart_html.window.on["hashchange"];

 dart_html.window.onHashChange.listen((dart_html.Event event) {
   var token = '';
   String hash = dart_html.window.location.hash;
   if (hash.length &gt; 0) {
     token = decodeFragment(hash.substring(1));
   }

   HistoryImpl.setToken(token);

//      if (oldHandler) {
//        oldHandler();
//      }
 });

 return true;

}
</pre>
</div>
</div>
<div class="method"><h4 id="nativeUpdate">
<button class="show-code">Code</button>
void <strong>nativeUpdate</strong>(String historyToken) <a class="anchor-link" href="#nativeUpdate"
              title="Permalink to HistoryImpl.nativeUpdate">#</a></h4>
<div class="doc">
<pre class="source">
void nativeUpdate(String historyToken) {
 //$wnd.location.hash = this.@com.google.gwt.user.client.impl.HistoryImpl::encodeFragment(Ljava/lang/String;)(historyToken);
 dart_html.window.location.hash = encodeFragment(historyToken);
}
</pre>
</div>
</div>
<div class="method"><h4 id="nativeUpdateOnEvent">
<button class="show-code">Code</button>
void <strong>nativeUpdateOnEvent</strong>(String historyToken) <a class="anchor-link" href="#nativeUpdateOnEvent"
              title="Permalink to HistoryImpl.nativeUpdateOnEvent">#</a></h4>
<div class="doc">
<pre class="source">
void nativeUpdateOnEvent(String historyToken) {
 // Do nothing, the hash is already updated.
}
</pre>
</div>
</div>
<div class="method"><h4 id="newItem">
<button class="show-code">Code</button>
void <strong>newItem</strong>(String historyToken, bool issueEvent) <a class="anchor-link" href="#newItem"
              title="Permalink to HistoryImpl.newItem">#</a></h4>
<div class="doc">
<pre class="source">
void newItem(String historyToken, bool issueEvent) {
 historyToken = (historyToken == null) ? "" : historyToken;
 if (historyToken != getToken()) {
   setToken(historyToken);
   nativeUpdate(historyToken);
   if (issueEvent) {
     fireHistoryChangedImpl(historyToken);
   }
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="newItemOnEvent">
<button class="show-code">Code</button>
void <strong>newItemOnEvent</strong>(String historyToken) <a class="anchor-link" href="#newItemOnEvent"
              title="Permalink to HistoryImpl.newItemOnEvent">#</a></h4>
<div class="doc">
<pre class="source">
void newItemOnEvent(String historyToken) {
 historyToken = (historyToken == null) ? "" : historyToken;
 if (historyToken != getToken()) {
   setToken(historyToken);
   nativeUpdateOnEvent(historyToken);
   fireHistoryChangedImpl(historyToken);
 }
}
</pre>
</div>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        <div class="footer">
          <div>This page was generated at 2013-05-06 21:15:15.463</div>
        </div>
        <script async src="../client-live-nav.js"></script>
        </body></html>
        
